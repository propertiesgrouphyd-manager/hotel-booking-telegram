<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Property Details</title>

  <style>
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:#f5f5f5;
      color:#111;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:18px;
    }
    @media (max-width:640px){
      .container{ padding:14px; }
    }

    .topbar{
      background:#fff;
      padding:16px;
      border-radius:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      margin-bottom:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      font-weight:800;
      font-size:18px;
      word-break:break-word;
    }

    .btn{
      border:none;
      background:#0b5ed7;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
    }

    .header{
      background:#fff;
      border-radius:14px;
      padding:16px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      margin-bottom:14px;
      min-width:0;
    }

    .meta{
      font-size:13px;
      color:#444;
      margin-top:6px;
      word-break:break-word;
      line-height:1.35;
    }

    .pillrow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .pill{
      background:#f0f2f5;
      border:1px solid #e5e5e5;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
    }

    .floors{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:12px;
    }

    .floorbtn{
      border:1px solid #ddd;
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .floorbtn.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .rooms{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }

    @media (max-width: 980px){
      .rooms{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 740px){
      .rooms{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px){
      .rooms{ grid-template-columns: 1fr; }
    }

    .room{
      background:#fff;
      border-radius:14px;
      padding:14px;
      border:1px solid #eee;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      min-width:0;
      overflow:hidden;
    }

    .room .title{
      font-weight:900;
      font-size:16px;
      word-break:break-word;
      line-height:1.2;
    }

    .room .sub{
      margin-top:6px;
      font-size:13px;
      color:#555;
      word-break:break-word;
    }

    .tag{
      display:inline-block;
      margin-top:10px;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid #eee;
      background:#f0f2f5;
    }

    .tag.available{
      background:#e7f7ef;
      border-color:#bfead2;
      color:#0b6b39;
    }
    .tag.booked{
      background:#ffecec;
      border-color:#ffcccc;
      color:#b30000;
    }

    /* ‚úÖ View Room button same design family */
    .viewbtn{
      margin-top:10px;
      width:100%;
      border:none;
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
    }

    /* ‚úÖ 3D Card Viewer Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }

    .modal.active{ display:flex; }

    .modal-card{
      width:min(950px, 100%);
      background:#fff;
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
      transform: perspective(1200px) rotateX(2deg);
    }

    .modal-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .modal-title{
      font-weight:900;
      font-size:16px;
      word-break:break-word;
    }

    .closebtn{
      border:none;
      background:#0b5ed7;
      color:#fff;
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
    }

    .gallery{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }

    @media(max-width: 720px){
      .gallery{ grid-template-columns: repeat(2, 1fr); }
    }
    @media(max-width: 480px){
      .gallery{ grid-template-columns: 1fr; }
    }

    .imgbox{
      border-radius:14px;
      overflow:hidden;
      border:1px solid #eee;
      background:#f5f5f5;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      transform: perspective(1000px) rotateY(-1deg);
    }

    .imgbox img{
      width:100%;
      height:220px;
      object-fit:cover;
      display:block;
    }

    .empty{
      padding:14px;
      font-size:13px;
      color:#444;
      background:#f0f2f5;
      border:1px solid #e5e5e5;
      border-radius:14px;
      font-weight:800;
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="brand" id="propTitle">Property</div>
      <button class="btn" onclick="goBack()">Back</button>
    </div>

    <div class="header">
      <div id="propName" style="font-size:18px; font-weight:900;"></div>
      <div class="meta" id="propAddress"></div>

      <div class="pillrow">
        <div class="pill" id="todayPrice">Today Price: ‚Çπ0</div>
        <div class="pill" id="appArr">App ARR: ‚Çπ0</div>
      </div>

      <div class="pillrow">
        <a id="mapLink" target="_blank" style="text-decoration:none; font-weight:900;">üìç Open Map</a>
      </div>
    </div>

    <div class="floors" id="floors"></div>
    <div class="rooms" id="rooms"></div>

  </div>

  <!-- ‚úÖ Room images modal -->
  <div class="modal" id="roomModal">
    <div class="modal-card">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle">Room Photos</div>
        <button class="closebtn" onclick="closeModal()">Close</button>
      </div>
      <div id="gallery" class="gallery"></div>
    </div>
  </div>

  <script>
    function goBack(){ window.location.href = "search.html"; }

    function qs(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    let ALL_ROOMS = [];
    let ACTIVE_FLOOR = null;
    let PROPERTY_CODE = "";

    function renderFloors(floors){
      const box = document.getElementById("floors");
      box.innerHTML = "";

      floors.forEach(f=>{
        const btn = document.createElement("button");
        btn.className = "floorbtn" + (f === ACTIVE_FLOOR ? " active" : "");
        btn.textContent = "Floor " + f;
        btn.onclick = ()=>{
          ACTIVE_FLOOR = f;
          renderFloors(floors);
          renderRooms();
        };
        box.appendChild(btn);
      });
    }

    function openModal(){ document.getElementById("roomModal").classList.add("active"); }
    function closeModal(){ document.getElementById("roomModal").classList.remove("active"); }

    async function viewRoom(roomNo){
      const title = document.getElementById("modalTitle");
      title.textContent = `Room ${roomNo} Photos`;

      const g = document.getElementById("gallery");
      g.innerHTML = "";

      openModal();

      try{
        const res = await fetch(`/api/room-images/${encodeURIComponent(PROPERTY_CODE)}/${encodeURIComponent(roomNo)}`);
        const data = await res.json();
        const imgs = data.images || [];

        if(!imgs.length){
          g.innerHTML = `<div class="empty">No photos uploaded yet for this room.<br><br>
          Upload photos to:<br><b>/home/ubuntu/hotel-booking/room_photos/${PROPERTY_CODE}/${roomNo}/</b></div>`;
          return;
        }

        for(const src of imgs){
          const div = document.createElement("div");
          div.className = "imgbox";
          div.innerHTML = `<img src="${src}" alt="Room Photo"/>`;
          g.appendChild(div);
        }

      }catch(e){
        g.innerHTML = `<div class="empty">Failed to load room images.</div>`;
      }
    }

    function renderRooms(){
      const box = document.getElementById("rooms");
      box.innerHTML = "";

      const list = ALL_ROOMS.filter(r => (ACTIVE_FLOOR ? r.floor === ACTIVE_FLOOR : true));
      for(const r of list){
        const div = document.createElement("div");
        div.className = "room";

        const statusClass = r.status === "booked" ? "booked" : "available";
        const statusText  = r.status === "booked" ? "Booked" : "Available";

        div.innerHTML = `
          <div class="title">Room ${r.room}</div>
          <div class="sub">Type: ${r.type || "Standard"}</div>
          <span class="tag ${statusClass}">${statusText}</span>
          <button class="viewbtn" onclick="viewRoom('${r.room}')">View Room</button>
        `;
        box.appendChild(div);
      }
    }

    async function loadProperty(){
      const code = qs("code");
      if(!code){ alert("Invalid property"); return; }

      PROPERTY_CODE = code;
      document.getElementById("propTitle").textContent = code;

      const from = new Date().toISOString().slice(0,10);
      const toDate = new Date(Date.now()+86400000).toISOString().slice(0,10);

      const url = `/api/property/${encodeURIComponent(code)}?from=${encodeURIComponent(from)}&to=${encodeURIComponent(toDate)}`;

      const res = await fetch(url);
      const data = await res.json();

      document.getElementById("propName").textContent = data.name || code;
      document.getElementById("propAddress").textContent = data.address || "";
      document.getElementById("todayPrice").textContent = "Today Price: ‚Çπ" + Math.round(data.yesterday_arr || 0);
      document.getElementById("appArr").textContent = "App ARR: ‚Çπ" + Math.round(data.app_arr || 0);

      const map = document.getElementById("mapLink");
      map.href = data.map_link || "#";
      map.style.pointerEvents = data.map_link ? "auto" : "none";
      map.style.opacity = data.map_link ? "1" : "0.5";

      ALL_ROOMS = data.rooms || [];
      const floors = data.floors || [];

      ACTIVE_FLOOR = floors[0] || null;
      renderFloors(floors);
      renderRooms();
    }

    // close modal on background click
    document.getElementById("roomModal").addEventListener("click", (e)=>{
      if(e.target.id === "roomModal") closeModal();
    });

    loadProperty();
  </script>
</body>
</html>
