name: Build & Deploy (Backend + Frontend)

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ✅ Deploy using SSH (industry standard)
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e

            echo "✅ Connected to server"
            echo "========================"
            echo "1) Pull latest code"
            echo "========================"

            cd /home/ubuntu/hotel-booking
            git fetch --all
            git reset --hard origin/main

            echo "========================"
            echo "2) Backend Deploy"
            echo "========================"

            cd /home/ubuntu/hotel-booking/backend

            # ✅ Ensure venv exists
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi

            source venv/bin/activate

            # ✅ install requirements if file exists
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            else
              # fallback: ensure core packages exist
              pip install fastapi uvicorn aiohttp python-dotenv
            fi

            sudo systemctl restart hotel-booking-backend
            sudo systemctl status hotel-booking-backend --no-pager

            echo "========================"
            echo "3) Frontend Deploy"
            echo "========================"

            sudo mkdir -p /var/www/hotel-booking

            # ✅ Copy updated html files
            sudo cp -r /home/ubuntu/hotel-booking/frontend/* /var/www/hotel-booking/

            # ✅ Permissions
            sudo chown -R www-data:www-data /var/www/hotel-booking
            sudo chmod -R 755 /var/www/hotel-booking

            sudo nginx -t
            sudo systemctl reload nginx

            echo "========================"
            echo "4) Health Check"
            echo "========================"

            curl -s http://127.0.0.1:8000/api/health
            echo ""
            echo "✅ DEPLOY SUCCESSFUL"
